{% include "partial/header.html" %}
{% include "partial/search.html" %}
{% include "partial/sync_reload.html" %}

<main class="flex-grow">
    <div class="flex flex-col md:flex-row w-full">

        <!-- Main content section -->
        <div id="main-content" class="px-4 py-6 order-1 md:order-2 w-full">
            {% include "partial/loading.html" %}

            <div class="flex justify-start items-center my-4">
                <div id="paginationTop" class="inline-flex flex-wrap items-center gap-1"></div>
            </div>

            <div id="grid" class="grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-7">

            </div>

            <div class="flex justify-start items-center my-4">
                <div id="paginationBottom" class="inline-flex flex-wrap items-center gap-1"></div>
            </div>

        </div>

        {% include "partial/tagbar.html" %}

    </div>
</main>

<script>
    const grid = document.getElementById("grid");

    function getApiUrl() {
        const path = window.location.pathname;
        const search = window.location.search;
        return "/api/item" + (path === "/" ? "" : path) + search;
    }

    function renderPagination(currentPage, totalPages) {
        const top = document.getElementById("paginationTop");
        const bottom = document.getElementById("paginationBottom");
        top.innerHTML = bottom.innerHTML = "";

        const makeBtn = (label, page, disabled = false, isActive = false) => {
            // Clone current URL params
            const newParams = new URLSearchParams(window.location.search);
            newParams.set("page", page); // update page number

            const btn = document.createElement("a");
            btn.textContent = label;
            btn.href = `/?${newParams.toString()}`;
            btn.className =
                "px-3 py-1 mx-1 rounded text-sm " +
                (disabled
                    ? "bg-gray-900 text-gray-500 pointer-events-none"
                    : isActive
                        ? "bg-purple-700 text-white font-bold"
                        : "bg-gray-800 text-white hover:bg-gray-700 transition");
            return btn;
        };

        const createPagination = (container) => {
            container.appendChild(makeBtn("First", 1, currentPage === 1));
            container.appendChild(makeBtn("Prev", Math.max(1, currentPage - 1), currentPage === 1));

            const range = 3; // how many pages before/after current
            const start = Math.max(1, currentPage - range);
            const end = Math.min(totalPages, currentPage + range);

            if (start > 2) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            for (let i = start; i <= end; i++) {
                container.appendChild(makeBtn(i, i, false, i === currentPage));
            }

            if (end < totalPages - 1) {
                const dots = document.createElement("span");
                dots.textContent = "...";
                dots.className = "text-gray-500 px-1";
                container.appendChild(dots);
            }

            container.appendChild(makeBtn("Next", Math.min(totalPages, currentPage + 1), currentPage === totalPages));
            container.appendChild(makeBtn("Last", totalPages, currentPage === totalPages));
        };

        createPagination(top);
        createPagination(bottom);
    }

    async function refreshContent() {
        showLoading(true);

        try {
            const res = await fetch(getApiUrl());
            const data = await res.json();

            showLoading(false);
            grid.innerHTML = "";

            display_tag(data.tags);

            data.items.forEach(item => {
                const card = document.createElement("div");
                card.className = "relative bg-gray-900 border border-gray-700 rounded-lg overflow-hidden shadow-md";
                let info = {};
                try {
                    info = JSON.parse(item.info);
                } catch (err) {
                    info = {};
                }
                const modelType = info?.model?.type || "";
                const modelTypeTag = modelType.toLowerCase().replace(/\s+/g, "_");
                const baseModel = info?.baseModel || "";
                const baseModelTag = baseModel.toLowerCase().replace(/\s+/g, "_");
                let preview_tag = `<img src="/assets/no_image.png" alt="${item.name}" class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">`;
                if (item.preview !== "") {
                     preview_tag = `<img src="${item.preview}" alt="${item.name}" class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">`;
                } else {
                    const video_preview = item.video_preview || "";
                    if (video_preview !== "") {
                        preview_tag = `<video src="${item.video_preview}" muted controls class="w-full aspect-w-1 aspect-h-1 object-cover bg-gray-100">
                                            Your browser does not support the video tag.</video>`
                    }
                }
                card.innerHTML = `
                    <div class="relative">
                        <a href="/item/${item.id}">
                            ${preview_tag}
                        </a>

                        <div class="absolute top-0 left-0 m-2 px-2 py-1 bg-purple-700 text-white text-xs font-semibold rounded">
                            <a href="?search=${modelTypeTag}&tag_only=true">${modelType}</a>
                        </div>
                        <div class="absolute top-0 right-0 m-2 px-2 py-1 bg-purple-700 text-white text-xs font-semibold rounded">
                            <a href="?search=${baseModelTag}&tag_only=true">${baseModel}</a>
                        </div>
                        <button
                            onclick="handleDelete(${item.id}); event.stopPropagation();"
                            title="Move to trash"
                            class="absolute bottom-0 right-0 m-2 z-10 text-sm bg-red-900 hover:bg-red-700 text-white focus:outline-none focus:shadow-outline font-bold py-2 px-4 rounded">
                            üóëÔ∏è
                        </button>
                    </div>

                    <h2 class="text-md font-semibold truncate">
                        <a href="/item/${item.id}">${item.name}</a>
                    </h2>
                `;

                grid.appendChild(card);
            });

            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get("page") || "1");

            renderPagination(page, data.total_page);

        } catch (err) {
            grid.innerHTML = `<p class="text-red-400 text-center py-10">Failed to load items: ${err.message}</p>`;
        }

    }

    // Initial load
    refreshContent();
</script>

<script>
    function handleDelete(id) {
        if (!confirm('Are you sure want to move this item to trash?')) return;

        fetch(`/api/item/delete?id=${id}`)
            .then(res => {
                if (res.ok) {
                    location.reload();
                } else {
                    alert("Failed to delete the item.");
                }
            })
            .catch(err => {
                console.error("Delete failed:", err);
                alert("Error while deleting.");
            });
    }
</script>

{% include "partial/footer.html" %}